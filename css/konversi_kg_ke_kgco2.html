<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Penggunaan Kertas dan Emisi CO2</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Monitoring Penggunaan Kertas dan Emisi CO2</h1>
    </header>
    <main>
        <div id="chartContainer"></div>
    </main>
    <footer>
        <p>&copy; 2024 Monitoring Penggunaan Kertas</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANIU-bLZYsrWwU9FOYQI2QY-V3deOxZ1E",
            authDomain: "monitoring-penggunaan-kertas.firebaseapp.com",
            databaseURL: "https://monitoring-penggunaan-kertas-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "monitoring-penggunaan-kertas",
            storageBucket: "monitoring-penggunaan-kertas.appspot.com",
            messagingSenderId: "925210231739",
            appId: "1:925210231739:web:95020c2af050c8925bfa9e"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const usageData = {
            ADM: Array(12).fill(0),
            Sparepart: Array(12).fill(0),
            Service: Array(12).fill(0)
        };

        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        const updateUsageData = (department, data) => {
            for (const id in data) {
                const usage = data[id];
                const date = new Date(usage.timestamp);
                const year = date.getFullYear();
                const month = date.getMonth();
                if (year === 2024) {
                    const weight = usage.penggunaanKertas * 0.005;
                    const emission = weight * 1.2;
                    const overLimit = emission > 86.0475 ? "YES" : "NO";
                    usageData[department][month] += weight;

                    console.log(`Department: ${department}, Year: ${year}, Month: ${monthNames[month]}, Sheets Used: ${usage.penggunaanKertas}, Weight: ${weight}, Emission: ${emission}, Over Limit: ${overLimit}`);
                }
            }
        };

        const loadData = () => {
            const admRef = ref(database, 'adm_department/penggunaanKertas');
            const sparepartRef = ref(database, 'sparepart_department/penggunaanKertas');
            const serviceRef = ref(database, 'service_department/penggunaanKertas');

            onValue(admRef, (snapshot) => {
                const data = snapshot.val();
                if (data) updateUsageData('ADM', data);
            });

            onValue(sparepartRef, (snapshot) => {
                const data = snapshot.val();
                if (data) updateUsageData('Sparepart', data);
            });

            onValue(serviceRef, (snapshot) => {
                const data = snapshot.val();
                if (data) updateUsageData('Service', data);
            });

            onDataLoad();
        };

        const onDataLoad = () => {
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.innerHTML = '';

            const canvasId = 'usageChart2024';
            const canvas = `<canvas id="${canvasId}" width="400" height="200"></canvas>`;
            chartContainer.innerHTML += `<div class="chart-container"><h2>Data Penggunaan Kertas dan Emisi CO2 Tahun 2024</h2>${canvas}</div>`;

            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: 'ADM',
                            data: usageData.ADM,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'Sparepart',
                            data: usageData.Sparepart,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'Service',
                            data: usageData.Service,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        };

        window.onload = loadData;
    </script>
</body>
</html>
